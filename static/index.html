<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>モールス信号メッセージ送信機</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic Medium",
          "Meiryo", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #333;
      }
      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        width: 90%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      h1 {
        text-align: center;
        color: #4a5568;
        margin-bottom: 2rem;
        font-size: 2rem;
        font-weight: 300;
      }
      .main-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
      }
      .input-group {
        display: flex;
        gap: 1rem;
        align-items: stretch;
      }
      #messageInput {
        flex: 1;
        padding: 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        outline: none;
      }
      #messageInput:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      .btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }
      .btn-secondary {
        background: #718096;
        color: white;
      }
      .btn-secondary:hover {
        background: #4a5568;
        transform: translateY(-2px);
      }
      .btn-danger {
        background: #e53e3e;
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
      }
      .btn-danger:hover {
        background: #c53030;
      }
      .btn-edit {
        background: #38a169;
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
      }
      .btn-edit:hover {
        background: #2f855a;
      }
      .message-pool {
        flex: 1;
        overflow-y: auto;
      }
      .message-pool h2 {
        color: #4a5568;
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: 300;
      }
      .message-item {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
      }
      .message-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      .message-text {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2d3748;
      }
      .message-actions {
        display: flex;
        gap: 0.5rem;
      }
      .message-morse {
        font-family: "Courier New", monospace;
        color: #718096;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }
      .message-meta {
        font-size: 0.8rem;
        color: #a0aec0;
        display: flex;
        justify-content: space-between;
      }
      .edit-form {
        margin-top: 1rem;
        display: none;
      }
      .edit-form.active {
        display: flex;
        gap: 1rem;
        align-items: center;
      }
      .edit-form input {
        flex: 1;
        padding: 0.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 5px;
        font-size: 0.9rem;
      }
      .edit-form input:focus {
        border-color: #667eea;
        outline: none;
      }
      .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
      }
      .status-unsent {
        background: #38a169;
      }
      .status-sent {
        background: #718096;
      }
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
      }
      .notification.show {
        transform: translateX(0);
      }
      .notification.success {
        background: linear-gradient(135deg, #38a169, #48bb78);
      }
      .notification.error {
        background: linear-gradient(135deg, #e53e3e, #fc8181);
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      .sending {
        animation: pulse 1s infinite;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>A -.- SHIMA, F --.-- L L</h1>
      <div class="main-form">
        <div class="input-group">
          <input
            type="text"
            id="messageInput"
            placeholder="モールス信号に変換するメッセージを入力してください"
          />
          <button class="btn btn-primary" onclick="submitMessage()">
            メッセージ送信
          </button>
        </div>
      </div>
      <div id="messagePool" class="message-pool">
        <h2>メッセージ管理</h2>
        <div id="messageList"></div>
      </div>
    </div>
    <script>
      let messages = [];
      let editingId = null;

      // Japanese date formatting function
      function formatJapaneseDateTime(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const hour = date.getHours().toString().padStart(2, "0");
        const minute = date.getMinutes().toString().padStart(2, "0");
        return `${year}年${month}月${day}日 ${hour}:${minute}`;
      }

      function showNotification(message, type) {
        // Remove any existing notifications
        const existingNotification = document.querySelector(".notification");
        if (existingNotification) {
          existingNotification.remove();
        }
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        // Show notification
        setTimeout(() => {
          notification.classList.add("show");
        }, 100);
        // Hide notification after 3 seconds
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => {
            notification.remove();
          }, 300);
        }, 3000);
      }

      async function submitMessage() {
        const input = document.getElementById("messageInput");
        const text = input.value.trim();
        if (!text) {
          showNotification("メッセージを入力してください", "error");
          return;
        }
        try {
          const response = await fetch("/api/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ text }),
          });
          if (response.ok) {
            input.value = "";
            showNotification("メッセージを正常に追加しました！", "success");
            await loadMessages();
          } else {
            showNotification("メッセージの送信に失敗しました", "error");
          }
        } catch (error) {
          console.error("エラー:", error);
          showNotification("ネットワークエラー", "error");
        }
      }

      async function loadMessages() {
        try {
          const response = await fetch("/api/messages");
          messages = await response.json();
          renderMessages();
        } catch (error) {
          console.error("メッセージ読み込みエラー:", error);
        }
      }

      function renderMessages() {
        const messageList = document.getElementById("messageList");
        messageList.innerHTML = "";
        if (messages.length === 0) {
          messageList.innerHTML =
            '<p style="text-align: center; color: #a0aec0; font-style: italic;">プール内にメッセージがありません</p>';
          return;
        }
        // Sort messages by creation time (newest first)
        const sortedMessages = [...messages].sort(
          (a, b) => new Date(b.created_at) - new Date(a.created_at),
        );
        sortedMessages.forEach((message) => {
          const messageDiv = document.createElement("div");
          messageDiv.className = "message-item";
          messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="message-text">
                            <span class="status-indicator ${message.last_sent ? "status-sent" : "status-unsent"}"></span>
                            ${message.text}
                        </div>
                        <div class="message-actions">
                            <button class="btn btn-edit" onclick="startEdit('${message.id}')">編集</button>
                            <button class="btn btn-danger" onclick="deleteMessage('${message.id}')">削除</button>
                        </div>
                    </div>
                    <div class="message-morse">${message.morse_code}</div>
                    <div class="message-meta">
                        <span>作成日時: ${formatJapaneseDateTime(message.created_at)}</span>
                        <span>送信回数: ${message.send_count}回 ${message.last_sent ? "(最終送信: " + formatJapaneseDateTime(message.last_sent) + ")" : "(未送信)"}</span>
                    </div>
                    <div class="edit-form" id="edit-${message.id}">
                        <input type="text" value="${message.text}" id="editInput-${message.id}" />
                        <button class="btn btn-primary" onclick="saveEdit('${message.id}')">保存</button>
                        <button class="btn btn-secondary" onclick="cancelEdit('${message.id}')">キャンセル</button>
                    </div>
                `;
          messageList.appendChild(messageDiv);
        });
      }

      function startEdit(id) {
        if (editingId && editingId !== id) {
          cancelEdit(editingId);
        }
        editingId = id;
        const editForm = document.getElementById(`edit-${id}`);
        editForm.classList.add("active");
        const input = document.getElementById(`editInput-${id}`);
        input.focus();
        input.select();
      }

      function cancelEdit(id) {
        const editForm = document.getElementById(`edit-${id}`);
        editForm.classList.remove("active");
        editingId = null;
      }

      async function saveEdit(id) {
        const input = document.getElementById(`editInput-${id}`);
        const text = input.value.trim();
        if (!text) {
          showNotification("メッセージは空にできません", "error");
          return;
        }
        try {
          const response = await fetch(`/api/messages/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ text }),
          });
          if (response.ok) {
            cancelEdit(id);
            showNotification("メッセージを正常に更新しました！", "success");
            await loadMessages();
          } else {
            showNotification("メッセージの更新に失敗しました", "error");
          }
        } catch (error) {
          console.error("エラー:", error);
          showNotification("ネットワークエラー", "error");
        }
      }

      async function deleteMessage(id) {
        if (!confirm("このメッセージを削除してもよろしいですか？")) {
          return;
        }
        try {
          const response = await fetch(`/api/messages/${id}`, {
            method: "DELETE",
          });
          if (response.ok) {
            showNotification("メッセージを正常に削除しました！", "success");
            await loadMessages();
          } else {
            showNotification("メッセージの削除に失敗しました", "error");
          }
        } catch (error) {
          console.error("エラー:", error);
          showNotification("ネットワークエラー", "error");
        }
      }

      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            submitMessage();
          }
        });

      document.addEventListener("DOMContentLoaded", function () {
        loadMessages();
        // Auto-refresh messages every 30 seconds
        setInterval(() => {
          loadMessages();
        }, 30000);
      });
    </script>
  </body>
</html>
